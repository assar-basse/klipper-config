[gcode_macro CANCEL_PRINT]
description: Cancel the current print safely using END_PRINT
rename_existing: CANCEL_PRINT_BASE
gcode:
    # Clear pause state if active
    CLEAR_PAUSE

    # If the printer is homed, run END_PRINT
    {% if printer.toolhead.homed_axes == "xyz" %}
        END_PRINT
    {% else %}
        # If not homed, do minimal safe shutdown
        M140 S0
        M104 S0
        M106 S0
        M18
    {% endif %}

    # Call Klipper's original cancel behavior
    CANCEL_PRINT_BASE
